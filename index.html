<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canvas ç¹ªåœ–å·¥å…· RWD ä¿®æ­£ç‰ˆ</title>
<style>
  body { 
    margin: 0; 
    padding: 0;
    font-family: Arial, sans-serif; 
    background: #f0f0f0;
    min-height: 100vh;
    overflow-x: auto;
    touch-action: auto;
  }
  
  .header {
    text-align: center;
    padding: 10px 0;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    z-index: 10;
    width: 100vw;
    box-sizing: border-box;
  }
  
  .controls { 
    margin: 10px 0; 
    padding: 0 10px;
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .color-btn { 
    width: 30px; 
    height: 30px; 
    display: inline-block; 
    cursor: pointer; 
    border: 1px solid #ccc; 
    border-radius: 3px;
  }
  
  .main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: calc(100vh - 200px);
    padding: 20px 0 50px 0;
    box-sizing: border-box;
  }
  
  #canvasContainer { 
    position: relative;
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    touch-action: none;
    overflow: visible;
    min-height: 400px;
  }
  
  canvas { 
    border: 2px solid #333;
    position: absolute !important; 
    top: 0 !important; 
    left: 0 !important; 
    touch-action: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    transform-origin: center center;
    transition: none;
    display: block !important;
    z-index: 1;
  }
  
  .upload-section { 
    margin: 10px 0; 
    padding: 10px; 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    width: 100%;
    box-sizing: border-box;
  }
  
  .upload-btn { 
    margin: 5px; 
    padding: 8px 15px; 
    background: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer;
    font-size: 14px;
  }
  
  .upload-btn:hover { 
    background: #45a049; 
  }
  
  .upload-btn.bg { 
    background: #2196F3; 
  }
  
  .upload-btn.bg:hover { 
    background: #0b7dda; 
  }
  
  .layer-info { 
    margin: 5px; 
    font-size: 12px; 
    color: #666; 
  }
  
  .control-btn {
    margin: 5px;
    padding: 8px 12px;
    background: #555;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .control-btn:hover {
    background: #333;
  }
  
  .slider-container {
    display: flex;
    align-items: center;
    margin: 5px;
    gap: 10px;
  }
  
  .slider-container input[type="range"] {
    width: 100px;
  }
  
  .sample-images-section {
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    width: 100%;
    box-sizing: border-box;
  }
  
  .section-title {
    font-size: 16px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
    text-align: center;
  }
  
  .sample-images-container {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .sample-image-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  
  .sample-image-item:hover {
    background-color: #f0f8ff;
    border-color: #2196F3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .sample-thumbnail {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: white;
    padding: 4px;
  }
  
  .sample-label {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    text-align: center;
  }
  
  .upload-btn.line-art { 
    background: #FF6B35; 
  }
  
  .upload-btn.line-art:hover { 
    background: #E55A2B; 
  }
  
  .processing-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    display: none;
  }
  
  @media (max-width: 768px) { 
    .color-btn { width: 25px; height: 25px; }
    .main-container {
      padding: 15px 0 30px 0;
    }
    .upload-btn, .control-btn {
      font-size: 12px;
      padding: 6px 10px;
    }
    .sample-thumbnail {
      width: 70px;
      height: 70px;
    }
    .sample-images-container {
      gap: 10px;
    }
  }
  
  @media (max-width: 480px) {
    .controls {
      margin: 5px 0;
      padding: 0 5px;
      gap: 3px;
    }
    .upload-section {
      margin: 5px 0;
      padding: 8px;
    }
    .sample-images-section {
      margin: 10px 0;
      padding: 10px;
    }
    .main-container {
      padding: 10px 0 20px 0;
    }
    .sample-thumbnail {
      width: 60px;
      height: 60px;
    }
    .section-title {
      font-size: 14px;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h2>Canvas ç¹ªåœ–å·¥å…·</h2>
  
  <div class="upload-section">
    <div class="layer-info">åœ–å±¤é †åºï¼šèƒŒæ™¯åœ– â†’ ç•«ç­†ç¹ªåœ– â†’ å»èƒŒåœ–ï¼ˆæœ€ä¸Šå±¤ï¼‰</div>
    <input type="file" id="uploadBg" accept="image/*" style="display:none" onchange="uploadBackgroundImage(event)">
    <button class="upload-btn bg" onclick="document.getElementById('uploadBg').click()">ä¸Šå‚³èƒŒæ™¯åœ–</button>
    
    <input type="file" id="uploadOverlay" accept="image/*" style="display:none" onchange="uploadOverlayImage(event)">
    <button class="upload-btn" onclick="document.getElementById('uploadOverlay').click()">ä¸Šå‚³å»èƒŒåœ–ï¼ˆæ¨è–¦PNGï¼‰</button>
    
    <input type="file" id="uploadToLineArt" accept="image/*" style="display:none" onchange="convertPhotoToLineArt(event)">
    <button class="upload-btn line-art" onclick="document.getElementById('uploadToLineArt').click()">ğŸ“¸ ç…§ç‰‡è½‰ç·šç¨¿</button>
    
    <button class="upload-btn" onclick="clearBackground()">æ¸…é™¤èƒŒæ™¯</button>
    <button class="upload-btn" onclick="clearOverlay()">æ¸…é™¤å»èƒŒåœ–</button>
  </div>

  <div class="controls" id="colorPalette"></div>
  <div class="controls">
    <button class="control-btn" onclick="setEraser()">æ©¡çš®æ“¦</button>
    <div class="slider-container">
      <label>ç²—ç´°ï¼š</label>
      <input type="range" id="lineWidth" min="1" max="20" value="1" onchange="changeLineWidth(this.value)">
      <span id="lineWidthValue">1</span>
    </div>
    <button class="control-btn" onclick="undo()">å¾©åŸ</button>
    <button class="control-btn" onclick="redo()">é‡åš</button>
    <button class="control-btn" onclick="clearDraw()">æ¸…é™¤ç•«ç­†</button>
    <button class="control-btn" onclick="downloadCanvas()">ä¸‹è¼‰åˆæˆåœ–</button>
  </div>

  <div class="sample-images-section">
    <div class="section-title">ç¯„ä¾‹åœ–ç‰‡</div>
    <div class="sample-images-container">
      <div class="sample-image-item" onclick="loadSampleImageTest(1)">
        <img src="https://github.com/farmeryi/coloring-game/raw/5f97cd68ce2b0dcd008401d700b110fbadfb685c/seed1.png" alt="ç¯„ä¾‹åœ–ç‰‡ 1" class="sample-thumbnail">
        <span class="sample-label">ç¯„ä¾‹ 1</span>
      </div>
      <div class="sample-image-item" onclick="loadSampleImageTest(2)">
        <img src="https://github.com/farmeryi/coloring-game/raw/5f97cd68ce2b0dcd008401d700b110fbadfb685c/seed2.png" alt="ç¯„ä¾‹åœ–ç‰‡ 2" class="sample-thumbnail">
        <span class="sample-label">ç¯„ä¾‹ 2</span>
      </div>
    </div>
  </div>
</div>

<div class="processing-indicator" id="processingIndicator">
  <div>æ­£åœ¨è½‰æ›ç…§ç‰‡ç‚ºç·šç¨¿...</div>
  <div style="margin-top: 10px;">è«‹ç¨å€™ï¼Œè™•ç†ä¸­...</div>
</div>

<div class="main-container">
  <div id="canvasContainer">
    <canvas id="bgCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <canvas id="overlayCanvas"></canvas>
  </div>
</div>

<script>
const bgCanvas = document.getElementById("bgCanvas");
const drawCanvas = document.getElementById("drawCanvas");
const overlayCanvas = document.getElementById("overlayCanvas");

const bgCtx = bgCanvas.getContext("2d");
const ctx = drawCanvas.getContext("2d");
const overlayCtx = overlayCanvas.getContext("2d");

let drawing = false;
let currentColor = "black";
let lineWidth = 1;
let isEraser = false;
let history = [];
let redoHistory = [];
let lastPos = {x:0,y:0};
let bgImage = null;
let overlayImage = null;

// é›™æŒ‡æ‰‹å‹¢ç›¸é—œè®Šæ•¸
let lastTouchDistance = 0;
let lastTouchCenter = {x: 0, y: 0};
let initialPinchDistance = 0;
let isPinching = false;
let touchStartTime = 0;
let multiTouchActive = false;
let lastTouchEndTime = 0;
let justFinishedMultiTouch = false;

// ç•«å¸ƒç¸®æ”¾å’Œä½ç½®ç›¸é—œè®Šæ•¸
let canvasScale = 1;
let canvasOffsetX = 0;
let canvasOffsetY = 0;
let minScale = 0.5;
let maxScale = 3;

// æ›´æ–°ç•«å¸ƒè®Šæ›
function updateCanvasTransform() {
  const transform = `translate(${canvasOffsetX}px, ${canvasOffsetY}px) scale(${canvasScale})`;
  [bgCanvas, drawCanvas, overlayCanvas].forEach(canvas => {
    canvas.style.transform = transform;
  });
}

// éŸ¿æ‡‰å¼ç•«å¸ƒèª¿æ•´
function resizeCanvas(){
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  let width, height;
  
  if (bgImage) {
    // æœ‰èƒŒæ™¯åœ–ç‰‡æ™‚ï¼Œæ ¹æ“šåœ–ç‰‡æ¯”ä¾‹èª¿æ•´
    const imgAspect = bgImage.width / bgImage.height;
    
    // å¯¬åº¦è¨­ç‚ºè¦–çª—å¯¬åº¦
    width = viewportWidth;
    height = width / imgAspect;
    
    // å¦‚æœé«˜åº¦è¶…éè¦–çª—é«˜åº¦çš„80%ï¼Œå‰‡èª¿æ•´
    const maxHeight = viewportHeight * 0.8;
    if (height > maxHeight) {
      height = maxHeight;
      width = height * imgAspect;
    }
  } else {
    // æ²’æœ‰èƒŒæ™¯åœ–ç‰‡æ™‚ï¼Œä½¿ç”¨è¦–çª—å¯¬åº¦å’Œ4:3æ¯”ä¾‹
    width = viewportWidth;
    height = width * 0.75; // 4:3æ¯”ä¾‹
    
    // ç¢ºä¿é«˜åº¦ä¸è¶…éè¦–çª—çš„80%
    const maxHeight = viewportHeight * 0.8;
    if (height > maxHeight) {
      height = maxHeight;
      width = height * (4/3);
    }
  }
  
  [bgCanvas, drawCanvas, overlayCanvas].forEach(c => {
    c.width = width;
    c.height = height;
    c.style.width = width + 'px';
    c.style.height = height + 'px';
    // ç¢ºä¿ç•«å¸ƒå¯è¦‹
    c.style.display = 'block';
    c.style.position = 'absolute';
    c.style.top = '0px';
    c.style.left = '0px';
  });
  
  // é‡ç½®ç¸®æ”¾å’Œä½ç½®
  canvasScale = 1;
  canvasOffsetX = 0;
  canvasOffsetY = 0;
  
  // ç¢ºä¿è®Šæ›æ­£ç¢ºæ‡‰ç”¨
  updateCanvasTransform();
  
  // è¨­ç½®ç™½è‰²é è¨­èƒŒæ™¯
  bgCtx.fillStyle = '#FFFFFF';
  bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
  
  redrawBackground();
  redrawDrawLayer();
  redrawOverlay();
}

window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', function() {
  setTimeout(resizeCanvas, 100);
});

// è¨ˆç®—å…©é»é–“è·é›¢
function getTouchDistance(touch1, touch2) {
  const dx = touch1.clientX - touch2.clientX;
  const dy = touch1.clientY - touch2.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// è¨ˆç®—å…©é»ä¸­å¿ƒé»
function getTouchCenter(touch1, touch2) {
  return {
    x: (touch1.clientX + touch2.clientX) / 2,
    y: (touch1.clientY + touch2.clientY) / 2
  };
}

// è§¸æ§èˆ‡æ»‘é¼ äº‹ä»¶
function getPos(e){
  const rect = drawCanvas.getBoundingClientRect();
  let clientX, clientY;
  if(e.touches && e.touches.length === 1){ 
    clientX = e.touches[0].clientX; 
    clientY = e.touches[0].clientY;
  } else { 
    clientX = e.clientX; 
    clientY = e.clientY;
  }
  
  // è€ƒæ…®ç•«å¸ƒçš„ç¸®æ”¾å’Œåç§»
  const x = (clientX - rect.left) / canvasScale;
  const y = (clientY - rect.top) / canvasScale;
  
  return { 
    x: x * (drawCanvas.width / (rect.width / canvasScale)),
    y: y * (drawCanvas.height / (rect.height / canvasScale))
  };
}

function startDraw(e){
  touchStartTime = Date.now();
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºé›™æŒ‡è§¸æ§
  if(e.touches && e.touches.length >= 2) {
    // é›™æŒ‡æ“ä½œ - ä¸é˜»æ­¢é è¨­è¡Œç‚ºè®“ç€è¦½å™¨è™•ç†ç¸®æ”¾
    isPinching = true;
    multiTouchActive = true;
    justFinishedMultiTouch = false;
    
    // è¨˜éŒ„é›™æŒ‡åˆå§‹ç‹€æ…‹
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    lastTouchDistance = getTouchDistance(touch1, touch2);
    lastTouchCenter = getTouchCenter(touch1, touch2);
    
    // åœæ­¢ä»»ä½•æ­£åœ¨é€²è¡Œçš„ç¹ªåœ–
    if(drawing) {
      drawing = false;
      ctx.closePath();
    }
    return;
  }
  
  // å–®æŒ‡è§¸æ§çš„è™•ç†
  if(e.touches && e.touches.length === 1) {
    // æª¢æŸ¥æ˜¯å¦å‰›çµæŸé›™æŒ‡æ“ä½œ
    if(justFinishedMultiTouch) {
      return; // åœ¨ä¿è­·æœŸå…§ï¼Œä¸é–‹å§‹ç¹ªåœ–
    }
    
    // é–‹å§‹å–®æŒ‡ç¹ªåœ–
    e.preventDefault();
    drawing = true;
    multiTouchActive = false;
    lastPos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastPos.x, lastPos.y);
    return;
  }
  
  // æ»‘é¼ äº‹ä»¶ï¼ˆæ¡Œé¢ç‰ˆï¼‰
  if(!e.touches) {
    e.preventDefault();
    drawing = true;
    multiTouchActive = false;
    lastPos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastPos.x, lastPos.y);
  }
}

function draw(e){
  // é›™æŒ‡æ‰‹å‹¢è™•ç† - ç¸®æ”¾å’Œæ‹–å‹•ç•«å¸ƒ
  if(e.touches && e.touches.length >= 2) {
    isPinching = true;
    multiTouchActive = true;
    
    // åœæ­¢ä»»ä½•æ­£åœ¨é€²è¡Œçš„ç¹ªåœ–
    if(drawing) {
      drawing = false;
      ctx.closePath();
    }
    
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentDistance = getTouchDistance(touch1, touch2);
    const currentCenter = getTouchCenter(touch1, touch2);
    
    if(lastTouchDistance > 0 && lastTouchCenter.x > 0) {
      // è¨ˆç®—ç¸®æ”¾
      const scaleChange = currentDistance / lastTouchDistance;
      const newScale = canvasScale * scaleChange;
      
      // é™åˆ¶ç¸®æ”¾ç¯„åœ
      if(newScale >= minScale && newScale <= maxScale) {
        canvasScale = newScale;
      }
      
      // è¨ˆç®—æ‹–å‹•
      const deltaX = currentCenter.x - lastTouchCenter.x;
      const deltaY = currentCenter.y - lastTouchCenter.y;
      
      canvasOffsetX += deltaX;
      canvasOffsetY += deltaY;
      
      // æ›´æ–°ç•«å¸ƒè®Šæ›
      updateCanvasTransform();
    }
    
    lastTouchDistance = currentDistance;
    lastTouchCenter = currentCenter;
    return; // ä¸é€²è¡Œç¹ªåœ–
  }
  
  // å–®æŒ‡ç¹ªåœ–
  if(!drawing || isPinching) return;
  
  const pos = getPos(e);
  ctx.lineWidth = lineWidth;
  ctx.lineCap = "round";
  ctx.strokeStyle = currentColor;
  ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
  ctx.beginPath();
  ctx.moveTo(lastPos.x, lastPos.y);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
  lastPos = pos;
}

function stopDraw(e){
  lastTouchEndTime = Date.now();
  
  // é›™æŒ‡æ“ä½œçµæŸ
  if(isPinching) {
    isPinching = false;
    lastTouchDistance = 0;
    justFinishedMultiTouch = true;
    
    // è¨­ç½®ä¿è­·æœŸï¼Œé˜²æ­¢ç«‹å³åˆ‡æ›åˆ°å–®æŒ‡ç¹ªåœ–
    setTimeout(() => {
      justFinishedMultiTouch = false;
      multiTouchActive = false;
    }, 300);
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦é‚„æœ‰è§¸æ§é»
  if(e.touches && e.touches.length > 0) {
    return;
  }
  
  // å–®æŒ‡ç¹ªåœ–çµæŸ
  if(drawing) {
    drawing = false;
    ctx.closePath();
    saveHistory();
  }
  
  // å–®æŒ‡æ“ä½œçµæŸï¼Œç«‹å³é‡ç½®ç‹€æ…‹
  if(!e.touches || e.touches.length === 0) {
    multiTouchActive = false;
  }
}

// äº‹ä»¶ç›£è½å™¨ç¶å®š
drawCanvas.addEventListener("mousedown", startDraw);
drawCanvas.addEventListener("mousemove", draw);
drawCanvas.addEventListener("mouseup", stopDraw);
drawCanvas.addEventListener("mouseout", stopDraw);
drawCanvas.addEventListener("touchstart", startDraw, {passive:false});
drawCanvas.addEventListener("touchmove", draw, {passive:false});
drawCanvas.addEventListener("touchend", stopDraw, {passive:false});

overlayCanvas.addEventListener("mousedown", startDraw);
overlayCanvas.addEventListener("mousemove", draw);
overlayCanvas.addEventListener("mouseup", stopDraw);
overlayCanvas.addEventListener("mouseout", stopDraw);
overlayCanvas.addEventListener("touchstart", startDraw, {passive:false});
overlayCanvas.addEventListener("touchmove", draw, {passive:false});
overlayCanvas.addEventListener("touchend", stopDraw, {passive:false});

// é¡è‰²èˆ‡æ©¡çš®æ“¦
function setColor(color){ currentColor=color; isEraser=false; }
function setEraser(){ isEraser=true; }

// ç²—ç´°èª¿æ•´
function changeLineWidth(value){ 
  lineWidth = value; 
  document.getElementById('lineWidthValue').textContent = value;
}

// æ¸…é™¤ç•«ç­†å±¤
function clearDraw(){
  ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  saveHistory();
}

// æ­·å²ç´€éŒ„
function saveHistory(){
  const imgData = drawCanvas.toDataURL();
  history.push(imgData);
  redoHistory = [];
  if(history.length > 50) history.shift();
}

// å¾©åŸ
function undo(){
  if(history.length>1){
    redoHistory.push(history.pop());
    const img = new Image();
    img.src = history[history.length-1];
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
  }
}

// é‡åš
function redo(){
  if(redoHistory.length>0){
    const imgData = redoHistory.pop();
    const img = new Image();
    img.src = imgData;
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
    history.push(imgData);
  }
}

// ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡
function uploadBackgroundImage(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    alert('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶ï¼');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      bgImage = img;
      resizeCanvas(); // é‡æ–°èª¿æ•´ç•«å¸ƒå°ºå¯¸ä»¥é…åˆåœ–ç‰‡
    };
    img.onerror = function() {
      alert('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
    };
    img.src = e.target.result;
  };
  reader.onerror = function() {
    alert('æ–‡ä»¶è®€å–å¤±æ•—ï¼');
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

// ä¸Šå‚³è¦†è“‹åœ–ç‰‡
function uploadOverlayImage(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    alert('è«‹ä¸Šå‚³åœ–ç‰‡æ–‡ä»¶ï¼ˆå»ºè­°ä½¿ç”¨ PNG æ ¼å¼ä»¥ä¿æŒé€æ˜æ•ˆæœï¼‰ï¼');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      overlayImage = img;
      redrawOverlay();
    };
    img.onerror = function() {
      alert('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
    };
    img.src = e.target.result;
  };
  reader.onerror = function() {
    alert('æ–‡ä»¶è®€å–å¤±æ•—ï¼');
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

// æ¸…é™¤èƒŒæ™¯
function clearBackground(){
  bgImage = null;
  resizeCanvas(); // é‡æ–°èª¿æ•´åˆ°é è¨­å°ºå¯¸
}

// æ¸…é™¤è¦†è“‹å±¤
function clearOverlay(){
  overlayImage = null;
  redrawOverlay();
  
  // æ¸…é™¤ç¯„ä¾‹åœ–ç‰‡çš„é¸ä¸­ç‹€æ…‹
  clearSampleSelection();
  
  console.log('å·²æ¸…é™¤å»èƒŒå±¤å’Œç¯„ä¾‹åœ–ç‰‡é¸ä¸­ç‹€æ…‹');
}

// é‡æ–°ç¹ªè£½èƒŒæ™¯
function redrawBackground(){
  // å…ˆå¡«å……ç™½è‰²èƒŒæ™¯
  bgCtx.fillStyle = '#FFFFFF';
  bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
  
  if(bgImage) {
    // å°‡åœ–ç‰‡å®Œå…¨å¡«æ»¿ç•«å¸ƒï¼Œä¿æŒæ¯”ä¾‹
    try {
      bgCtx.drawImage(bgImage, 0, 0, bgCanvas.width, bgCanvas.height);
    } catch(e) {
      alert('ç¹ªè£½èƒŒæ™¯åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼');
    }
  }
}

// é‡æ–°ç¹ªè£½ç•«ç­†å±¤
function redrawDrawLayer(){
  if(history.length>0){
    const img = new Image();
    img.src = history[history.length-1];
    img.onload = ()=>{
      ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      ctx.drawImage(img,0,0,drawCanvas.width,drawCanvas.height);
    }
  }else{
    ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  }
}

// é‡æ–°ç¹ªè£½è¦†è“‹å±¤
function redrawOverlay(){
  overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
  
  if(overlayImage) {
    try {
      // ä¿æŒåŸå§‹å°ºå¯¸å’Œé€æ˜åº¦ï¼Œå¡«æ»¿æ•´å€‹ç•«å¸ƒ
      overlayCtx.drawImage(overlayImage, 0, 0, overlayCanvas.width, overlayCanvas.height);
    } catch(e) {
      alert('ç¹ªè£½è¦†è“‹åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼');
    }
  }
}

// ä¸‹è¼‰åˆä½µåœ–ç‰‡ - ç°¡åŒ–ä½†æ›´å¯é çš„æ–¹æ³•
function downloadCanvas(){
  console.log('é–‹å§‹ä¸‹è¼‰ç•«å¸ƒå…§å®¹...');
  
  try {
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = drawCanvas.width;
    tempCanvas.height = drawCanvas.height;
    const tempCtx = tempCanvas.getContext("2d");
    
    // å…ˆè¨­ç½®ç™½è‰²èƒŒæ™¯
    tempCtx.fillStyle = '#FFFFFF';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    // å˜—è©¦ä¾åºåˆä½µæ‰€æœ‰åœ–å±¤
    console.log('åˆä½µèƒŒæ™¯å±¤...');
    tempCtx.drawImage(bgCanvas, 0, 0);
    
    console.log('åˆä½µè¦†è“‹å±¤ï¼ˆç¯„ä¾‹åœ–ç‰‡ï¼‰...');  
    tempCtx.drawImage(overlayCanvas, 0, 0);
    
    console.log('åˆä½µç¹ªåœ–å±¤...');
    tempCtx.drawImage(drawCanvas, 0, 0);
    
    // å˜—è©¦ç”Ÿæˆä¸‹è¼‰é€£çµ
    const dataURL = tempCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.download = "canvas_artwork_" + new Date().getTime() + ".png";
    link.href = dataURL;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('âœ… å®Œæ•´ä½œå“ä¸‹è¼‰æˆåŠŸï¼');
    
  } catch(error) {
    console.error('âŒ æ¨™æº–ä¸‹è¼‰å¤±æ•—:', error);
    console.log('å˜—è©¦æ‰‹å‹•é‡å»ºåœ–ç‰‡...');
    
    // æ‰‹å‹•é‡å»ºåœ–ç‰‡çš„å‚™ç”¨æ–¹æ¡ˆ
    downloadByManualComposition();
  }
}

// æ‰‹å‹•é‡å»ºåœ–ç‰‡é€²è¡Œä¸‹è¼‰
function downloadByManualComposition() {
  const tempCanvas = document.createElement("canvas");
  tempCanvas.width = drawCanvas.width;
  tempCanvas.height = drawCanvas.height;
  const tempCtx = tempCanvas.getContext("2d");
  
  // 1. ç™½è‰²èƒŒæ™¯
  tempCtx.fillStyle = '#FFFFFF';
  tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
  console.log('âœ… å·²æ·»åŠ ç™½è‰²èƒŒæ™¯');
  
  // 2. å¦‚æœæœ‰èƒŒæ™¯åœ–ï¼Œå˜—è©¦æ·»åŠ 
  if(bgImage) {
    try {
      tempCtx.drawImage(bgImage, 0, 0, tempCanvas.width, tempCanvas.height);
      console.log('âœ… å·²æ·»åŠ èƒŒæ™¯åœ–ç‰‡');
    } catch(e) {
      console.log('âš ï¸  èƒŒæ™¯åœ–ç‰‡è·³éï¼ˆè·¨åŸŸé™åˆ¶ï¼‰');
    }
  }
  
  // 3. å¦‚æœæœ‰ç¯„ä¾‹åœ–ç‰‡ï¼Œå˜—è©¦æ·»åŠ 
  if(overlayImage) {
    try {
      tempCtx.drawImage(overlayImage, 0, 0, tempCanvas.width, tempCanvas.height);
      console.log('âœ… å·²æ·»åŠ ç¯„ä¾‹åœ–ç‰‡');
    } catch(e) {
      console.log('âš ï¸  ç¯„ä¾‹åœ–ç‰‡ç„¡æ³•ç›´æ¥ä½¿ç”¨ï¼Œå˜—è©¦å¾è¦†è“‹ç•«å¸ƒè¤‡è£½...');
      
      // å˜—è©¦å¾è¦†è“‹ç•«å¸ƒè¤‡è£½å…§å®¹
      try {
        tempCtx.drawImage(overlayCanvas, 0, 0);
        console.log('âœ… å·²å¾è¦†è“‹ç•«å¸ƒè¤‡è£½ç¯„ä¾‹åœ–ç‰‡');
      } catch(e2) {
        console.log('âš ï¸  è¦†è“‹ç•«å¸ƒä¹Ÿç„¡æ³•è¤‡è£½ï¼Œè·³éç¯„ä¾‹åœ–ç‰‡');
      }
    }
  }
  
  // 4. æ·»åŠ ç¹ªåœ–å…§å®¹
  try {
    tempCtx.drawImage(drawCanvas, 0, 0);
    console.log('âœ… å·²æ·»åŠ ç¹ªåœ–å…§å®¹');
  } catch(e) {
    console.error('âŒ ç„¡æ³•æ·»åŠ ç¹ªåœ–å…§å®¹:', e);
  }
  
  // 5. å®Œæˆä¸‹è¼‰
  try {
    const dataURL = tempCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.download = "canvas_manual_" + new Date().getTime() + ".png";
    link.href = dataURL;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('âœ… æ‰‹å‹•é‡å»ºä¸‹è¼‰æˆåŠŸï¼');
    
  } catch(error) {
    console.error('âŒ æ‰‹å‹•é‡å»ºä¹Ÿå¤±æ•—:', error);
    
    // æœ€å¾Œçš„å‚™ç”¨æ–¹æ¡ˆï¼šåªä¸‹è¼‰ç¹ªåœ–
    try {
      const simpleCanvas = document.createElement("canvas");
      simpleCanvas.width = drawCanvas.width;
      simpleCanvas.height = drawCanvas.height;
      const simpleCtx = simpleCanvas.getContext("2d");
      
      simpleCtx.fillStyle = '#FFFFFF';
      simpleCtx.fillRect(0, 0, simpleCanvas.width, simpleCanvas.height);
      simpleCtx.drawImage(drawCanvas, 0, 0);
      
      const link = document.createElement("a");
      link.download = "canvas_drawing_only_" + new Date().getTime() + ".png";
      link.href = simpleCanvas.toDataURL("image/png");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('âœ… ç¹ªåœ–å…§å®¹ä¸‹è¼‰æˆåŠŸï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰');
      
    } catch(finalError) {
      console.error('âŒ æ‰€æœ‰ä¸‹è¼‰æ–¹æ¡ˆéƒ½å¤±æ•—:', finalError);
      alert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å˜—è©¦æˆªåœ–ä¿å­˜æ‚¨çš„ä½œå“ã€‚');
    }
  }
}

// 36è‰²èª¿è‰²ç›¤
const colors=[
"#000000","#808080","#C0C0C0","#FFFFFF","#800000","#FF0000",
"#808000","#FFFF00","#008000","#00FF00","#008080","#00FFFF",
"#000080","#0000FF","#800080","#FF00FF","#A52A2A","#FFA500",
"#B8860B","#FFD700","#2E8B57","#90EE90","#20B2AA","#40E0D0",
"#4169E1","#87CEEB","#6A5ACD","#9370DB","#FF1493","#FF69B4",
"#CD5C5C","#F08080","#708090","#D3D3D3","#F5F5DC","#FFE4C4"];

const palette = document.getElementById("colorPalette");
colors.forEach(c=>{
  const btn = document.createElement("div");
  btn.className="color-btn";
  btn.style.backgroundColor=c;
  btn.onclick=()=>setColor(c);
  btn.title = c;
  palette.appendChild(btn);
});

// åˆå§‹åŒ–
window.addEventListener('load', function() {
  resizeCanvas();
  saveHistory();
  
  // ç¢ºä¿ç•«å¸ƒå¯è¦‹
  console.log('Canvas elements:', {
    bgCanvas: bgCanvas,
    drawCanvas: drawCanvas,
    overlayCanvas: overlayCanvas,
    bgCanvasStyle: bgCanvas.style.cssText,
    drawCanvasStyle: drawCanvas.style.cssText
  });
  
  // æ¸¬è©¦ç¯„ä¾‹åœ–ç‰‡è¼‰å…¥
  console.log('ç¯„ä¾‹åœ–ç‰‡ç¶²å€æ¸¬è©¦:');
  console.log('seed1:', 'https://raw.githubusercontent.com/farmeryi/coloring-game/5f97cd68ce2b0dcd008401d700b110fbadfb685c/seed1.png');
  console.log('seed2:', 'https://raw.githubusercontent.com/farmeryi/coloring-game/5f97cd68ce2b0dcd008401d700b110fbadfb685c/seed2.png');
});

// è§¸æ§äº‹ä»¶è™•ç†
document.addEventListener('touchmove', function(e) {
  if(e.target.tagName === 'CANVAS') {
    // é˜»æ­¢æ‰€æœ‰é è¨­è¡Œç‚ºï¼Œè®“æˆ‘å€‘å®Œå…¨æ§åˆ¶
    e.preventDefault();
  }
}, {passive: false});

// è§¸æ§é–‹å§‹è™•ç†
document.addEventListener('touchstart', function(e) {
  if(e.target.tagName === 'CANVAS') {
    e.preventDefault();
    if(e.touches.length >= 2) {
      multiTouchActive = true;
      justFinishedMultiTouch = false;
    }
  }
}, {passive: false});

// è§¸æ§çµæŸè™•ç†
document.addEventListener('touchend', function(e) {
  if(e.target.tagName === 'CANVAS') {
    e.preventDefault();
    if(e.touches.length === 0) {
      // æ‰€æœ‰æ‰‹æŒ‡éƒ½é›¢é–‹äº†
      if(isPinching) {
        // å‰›çµæŸé›™æŒ‡æ“ä½œï¼Œè¨­ç½®ä¿è­·æœŸ
        setTimeout(() => {
          justFinishedMultiTouch = false;
          multiTouchActive = false;
        }, 300);
      } else {
        // å–®æŒ‡æ“ä½œçµæŸï¼Œç«‹å³é‡ç½®
        multiTouchActive = false;
        justFinishedMultiTouch = false;
      }
    }
  }
}, {passive: false});

</script>

</body>
</html>
